Plan to implement                                                                                                                                                                                                                                                                                                                                                                                                              │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Plan: Composition Rendering — NLE → MP4                                                                                                                                                                                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Context                                                                                                                                                                                                                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ NLE editor ma composition JSON (tracks, elements, positions, sizes). User klika "Render" w toolbarze.                                                                                                                                                                                                                                                                                                                          │
│ Potrzebujemy pipeline: Frontend → API → Job → video-editor Docker (FFmpeg) → output MP4 → download.                                                                                                                                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Istniejaca infrastruktura:                                                                                                                                                                                                                                                                                                                                                                                                     │
│ - docker/video-editor/server.py — Flask + FFmpeg, ma juz /add-captions, /export-timeline, /remove-silence                                                                                                                                                                                                                                                                                                                      │
│ - VideoEditorService.php — HTTP proxy do kontenera (attach file → POST → save response)                                                                                                                                                                                                                                                                                                                                        │
│ - RenderCaptionsJob / ExportTimelineJob — wzorce queue jobów z broadcast events                                                                                                                                                                                                                                                                                                                                                │
│ - TaskStarted/TaskCompleted events — WebSocket do powiadomień frontend                                                                                                                                                                                                                                                                                                                                                         │
│ - NleToolbar.vue — juz emituje @render, NleEditorPage.vue ma handleRender() (stub)                                                                                                                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ ---                                                                                                                                                                                                                                                                                                                                                                                                                            │
│ 1. Backend: /render-composition endpoint w video-editor (server.py)                                                                                                                                                                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Nowy endpoint Flask w docker/video-editor/server.py:                                                                                                                                                                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ POST /render-composition                                                                                                                                                                                                                                                                                                                                                                                                       │
│ - multipart/form-data:                                                                                                                                                                                                                                                                                                                                                                                                         │
│   - file_0, file_1, ... — pliki mediów (video, images)                                                                                                                                                                                                                                                                                                                                                                         │
│   - composition — JSON string                                                                                                                                                                                                                                                                                                                                                                                                  │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Logika FFmpeg:                                                                                                                                                                                                                                                                                                                                                                                                                 │
│ 1. Parse composition JSON → extract tracks/elements active at each time                                                                                                                                                                                                                                                                                                                                                        │
│ 2. Save received files to temp dir, map slot_0 → local path                                                                                                                                                                                                                                                                                                                                                                    │
│ 3. Build FFmpeg filter_complex:                                                                                                                                                                                                                                                                                                                                                                                                │
│   - Dla kazdego elementu video/image: [input]scale=WxH,setpts=...[label]                                                                                                                                                                                                                                                                                                                                                       │
│   - overlay chain: background → element 0 → element 1 → ... (bottom-to-top Z-order)                                                                                                                                                                                                                                                                                                                                            │
│   - Position mapping: element x/y (center-based %) → FFmpeg overlay (top-left px)                                                                                                                                                                                                                                                                                                                                              │
│   - Image elements: loop=1:1:0 → scale → overlay z enable filter (time range)                                                                                                                                                                                                                                                                                                                                                  │
│   - Audio: amerge/amix all audio elements + main video audio                                                                                                                                                                                                                                                                                                                                                                   │
│ 4. Output: -c:v libx264 -preset medium -crf 23 -c:a aac -movflags +faststart                                                                                                                                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Kluczowe konwersje:                                                                                                                                                                                                                                                                                                                                                                                                            │
│ - Element x: '50%', y: '50%' = center of element at 50% of composition → FFmpeg overlay x = (compW * x% / 100) - (elW / 2)                                                                                                                                                                                                                                                                                                     │
│ - Element width: '100%' → scale to compW pixels                                                                                                                                                                                                                                                                                                                                                                                │
│ - fit: 'cover' → scale + crop, fit: 'contain' → scale + pad                                                                                                                                                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ ---                                                                                                                                                                                                                                                                                                                                                                                                                            │
│ 2. Backend: VideoEditorService::renderComposition()                                                                                                                                                                                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Nowa metoda w app/Services/VideoEditorService.php:                                                                                                                                                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ public function renderComposition(VideoProject $project, array $composition, string $outputPath): string                                                                                                                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Logika:                                                                                                                                                                                                                                                                                                                                                                                                                        │
│ 1. Resolve all media:// URIs → actual file paths (reuse existing resolution logic)                                                                                                                                                                                                                                                                                                                                             │
│ 2. Build Http::attach() z numbered file slots: file_0, file_1, ...                                                                                                                                                                                                                                                                                                                                                             │
│ 3. Create slot mapping: { "slot_0": "media://video-projects/1/video.mp4", ... }                                                                                                                                                                                                                                                                                                                                                │
│ 4. Send composition JSON with slot references replacing media:// URIs                                                                                                                                                                                                                                                                                                                                                          │
│ 5. POST to {baseUrl}/render-composition                                                                                                                                                                                                                                                                                                                                                                                        │
│ 6. Save response body to $outputPath                                                                                                                                                                                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ ---                                                                                                                                                                                                                                                                                                                                                                                                                            │
│ 3. Backend: RenderCompositionJob                                                                                                                                                                                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Nowy job w app/Jobs/RenderCompositionJob.php, wzorowany na RenderCaptionsJob:                                                                                                                                                                                                                                                                                                                                                  │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ class RenderCompositionJob implements ShouldQueue                                                                                                                                                                                                                                                                                                                                                                              │
│ {                                                                                                                                                                                                                                                                                                                                                                                                                              │
│     public int $timeout = 900;                                                                                                                                                                                                                                                                                                                                                                                                 │
│     public int $tries = 2;                                                                                                                                                                                                                                                                                                                                                                                                     │
│     public int $backoff = 30;                                                                                                                                                                                                                                                                                                                                                                                                  │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│     public function __construct(protected VideoProject $project) {}                                                                                                                                                                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│     public function handle(VideoEditorService $editor): void                                                                                                                                                                                                                                                                                                                                                                   │
│     {                                                                                                                                                                                                                                                                                                                                                                                                                          │
│         // 1. broadcast TaskStarted                                                                                                                                                                                                                                                                                                                                                                                            │
│         // 2. project->markAs(Rendering)                                                                                                                                                                                                                                                                                                                                                                                       │
│         // 3. $editor->renderComposition($project, $project->composition, $outputPath)                                                                                                                                                                                                                                                                                                                                         │
│         // 4. project->update([output_path, status=Completed, completed_at])                                                                                                                                                                                                                                                                                                                                                   │
│         // 5. broadcast TaskCompleted                                                                                                                                                                                                                                                                                                                                                                                          │
│     }                                                                                                                                                                                                                                                                                                                                                                                                                          │
│ }                                                                                                                                                                                                                                                                                                                                                                                                                              │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ ---                                                                                                                                                                                                                                                                                                                                                                                                                            │
│ 4. Backend: Controller endpoint                                                                                                                                                                                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Nowa metoda w VideoProjectController.php:                                                                                                                                                                                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ public function renderComposition(Request $request, string $publicId): JsonResponse                                                                                                                                                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ - Validate: project has composition, not currently processing                                                                                                                                                                                                                                                                                                                                                                  │
│ - Auto-save composition from request body (if provided)                                                                                                                                                                                                                                                                                                                                                                        │
│ - Dispatch RenderCompositionJob                                                                                                                                                                                                                                                                                                                                                                                                │
│ - Return 200 with message                                                                                                                                                                                                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Nowy route w routes/api.php:                                                                                                                                                                                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ POST video-projects/{publicId}/render-composition                                                                                                                                                                                                                                                                                                                                                                              │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ ---                                                                                                                                                                                                                                                                                                                                                                                                                            │
│ 5. Frontend: Store action + UI wiring                                                                                                                                                                                                                                                                                                                                                                                          │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Store (videoEditorNew.js)                                                                                                                                                                                                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Nowa akcja:                                                                                                                                                                                                                                                                                                                                                                                                                    │
│ async renderComposition() {                                                                                                                                                                                                                                                                                                                                                                                                    │
│     if (!this.composition || !this.projectId) return;                                                                                                                                                                                                                                                                                                                                                                          │
│     // 1. Save composition first (auto-save)                                                                                                                                                                                                                                                                                                                                                                                   │
│     await this.saveComposition();                                                                                                                                                                                                                                                                                                                                                                                              │
│     // 2. POST /api/v1/video-projects/{id}/render-composition                                                                                                                                                                                                                                                                                                                                                                  │
│     // 3. Set rendering state (disable render button)                                                                                                                                                                                                                                                                                                                                                                          │
│     this.rendering = true;                                                                                                                                                                                                                                                                                                                                                                                                     │
│ }                                                                                                                                                                                                                                                                                                                                                                                                                              │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Nowy state: rendering: false                                                                                                                                                                                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ NleEditorPage.vue                                                                                                                                                                                                                                                                                                                                                                                                              │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ handleRender():                                                                                                                                                                                                                                                                                                                                                                                                                │
│ async function handleRender() {                                                                                                                                                                                                                                                                                                                                                                                                │
│     await autoSave.saveNow();                                                                                                                                                                                                                                                                                                                                                                                                  │
│     await store.renderComposition();                                                                                                                                                                                                                                                                                                                                                                                           │
│     toast.success(t('nle.render.started'));                                                                                                                                                                                                                                                                                                                                                                                    │
│ }                                                                                                                                                                                                                                                                                                                                                                                                                              │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ NleToolbar.vue                                                                                                                                                                                                                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Render button: disable when store.rendering || store.saving                                                                                                                                                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ WebSocket listener                                                                                                                                                                                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ W NleEditorPage.vue onMounted — listen to TaskCompleted event:                                                                                                                                                                                                                                                                                                                                                                 │
│ - If task_type === composition_render && project_id matches:                                                                                                                                                                                                                                                                                                                                                                   │
│   - store.rendering = false                                                                                                                                                                                                                                                                                                                                                                                                    │
│   - toast.success(t('nle.render.completed')) z link do download                                                                                                                                                                                                                                                                                                                                                                │
│   - Refresh project data                                                                                                                                                                                                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ ---                                                                                                                                                                                                                                                                                                                                                                                                                            │
│ Pliki do modyfikacji                                                                                                                                                                                                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ ┌────────────────────────────────────────────────────────┬─────────────────────────────────────────────┐                                                                                                                                                                                                                                                                                                                       │
│ │                          Plik                          │                   Zmiana                    │                                                                                                                                                                                                                                                                                                                       │
│ ├────────────────────────────────────────────────────────┼─────────────────────────────────────────────┤                                                                                                                                                                                                                                                                                                                       │
│ │ docker/video-editor/server.py                          │ Nowy /render-composition endpoint           │                                                                                                                                                                                                                                                                                                                       │
│ ├────────────────────────────────────────────────────────┼─────────────────────────────────────────────┤                                                                                                                                                                                                                                                                                                                       │
│ │ app/Services/VideoEditorService.php                    │ Nowa renderComposition() metoda             │                                                                                                                                                                                                                                                                                                                       │
│ ├────────────────────────────────────────────────────────┼─────────────────────────────────────────────┤                                                                                                                                                                                                                                                                                                                       │
│ │ app/Jobs/RenderCompositionJob.php                      │ NOWY — queue job                            │                                                                                                                                                                                                                                                                                                                       │
│ ├────────────────────────────────────────────────────────┼─────────────────────────────────────────────┤                                                                                                                                                                                                                                                                                                                       │
│ │ app/Http/Controllers/Api/V1/VideoProjectController.php │ Nowa renderComposition() metoda             │                                                                                                                                                                                                                                                                                                                       │
│ ├────────────────────────────────────────────────────────┼─────────────────────────────────────────────┤                                                                                                                                                                                                                                                                                                                       │
│ │ routes/api.php                                         │ Nowy route                                  │                                                                                                                                                                                                                                                                                                                       │
│ ├────────────────────────────────────────────────────────┼─────────────────────────────────────────────┤                                                                                                                                                                                                                                                                                                                       │
│ │ resources/js/stores/videoEditorNew.js                  │ renderComposition() action, rendering state │                                                                                                                                                                                                                                                                                                                       │
│ ├────────────────────────────────────────────────────────┼─────────────────────────────────────────────┤                                                                                                                                                                                                                                                                                                                       │
│ │ resources/js/components/nle/NleEditorPage.vue          │ handleRender() implementation + WebSocket   │                                                                                                                                                                                                                                                                                                                       │
│ ├────────────────────────────────────────────────────────┼─────────────────────────────────────────────┤                                                                                                                                                                                                                                                                                                                       │
│ │ resources/js/components/nle/NleToolbar.vue             │ Disable render button when rendering        │                                                                                                                                                                                                                                                                                                                       │
│ ├────────────────────────────────────────────────────────┼─────────────────────────────────────────────┤                                                                                                                                                                                                                                                                                                                       │
│ │ resources/js/i18n/locales/en.json                      │ Translation keys: nle.render.*              │                                                                                                                                                                                                                                                                                                                       │
│ ├────────────────────────────────────────────────────────┼─────────────────────────────────────────────┤                                                                                                                                                                                                                                                                                                                       │
│ │ resources/js/i18n/locales/pl.json                      │ Translation keys: nle.render.*              │                                                                                                                                                                                                                                                                                                                       │
│ └────────────────────────────────────────────────────────┴─────────────────────────────────────────────┘                                                                                                                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Kolejnosc implementacji                                                                                                                                                                                                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ 1. server.py — /render-composition endpoint z FFmpeg filter_complex                                                                                                                                                                                                                                                                                                                                                            │
│ 2. VideoEditorService.php — renderComposition() z media file resolution                                                                                                                                                                                                                                                                                                                                                        │
│ 3. RenderCompositionJob.php — nowy job                                                                                                                                                                                                                                                                                                                                                                                         │
│ 4. VideoProjectController.php + routes/api.php — endpoint                                                                                                                                                                                                                                                                                                                                                                      │
│ 5. Store + UI — render action, button state, WebSocket, toast                                                                                                                                                                                                                                                                                                                                                                  │
│ 6. Tlumaczenia                                                                                                                                                                                                                                                                                                                                                                                                                 │
│ 7. Docker rebuild + test                                                                                                                                                                                                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ Weryfikacja                                                                                                                                                                                                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                                                                                                                                                                                                │
│ 1. docker compose build video-editor && docker compose up -d video-editor                                                                                                                                                                                                                                                                                                                                                      │
│ 2. Test via tinker: create job manually, verify output MP4 is created                                                                                                                                                                                                                                                                                                                                                          │
│ 3. npx vite build — no frontend errors                                                                                                                                                                                                                                                                                                                                                                                         │
│ 4. Browser test: click Render → rendering state → completion toast → download works                                                                                                                                                                                                                                                                                                                                            │
│ 5. Test z multi-element composition: video + overlay image → verify layering                  
